name: Main Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # زرار للتشغيل اليدوي بدون اختيارات

jobs:
  ci-cd:
    runs-on: ubuntu-latest # الـ Build والـ Scan يفضلوا على سيرفرات جيت هاب (أسرع وأنظف)
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          FULL_TAG=${{ github.sha }}
          SHORT_TAG=$(echo $FULL_TAG | cut -c1-7)
          docker build -t quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:${FULL_TAG} \
                       -t quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:${SHORT_TAG} .

      - name: Download Trivy HTML Template
        run: |
          wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O html.tpl

      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:${{ github.sha }}'
          format: 'template'
          template: 'html.tpl'
          output: 'report.html'
          exit-code: '0'
          severity: 'CRITICAL'

      - name: Prepare Artifacts
        if: always()
        run: |
          mkdir -p scan-dir
          echo "Nginx version: alpine" > scan-dir/nginx.txt
          mkdir -p HTML
          if [ -f report.html ]; then
            cp report.html HTML/report.html
          else
            echo "No Trivy report found; continuing."
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-artifacts
          path: |
            scan-dir/
            HTML/

      - name: Login to Quay
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_TOKEN }}

      - name: Push Image
        run: |
          docker tag quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:${{ github.sha }} \
                     quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:latest
          docker push quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:${{ github.sha }}
          docker push quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:latest

  deploy:
    needs: ci-cd
    runs-on: self-hosted  # ✅ هينزل يرن على جهازك أنتِ
    steps:
      - name: Deploy Locally (Self-Hosted)
        run: |
          # 1. Login
          echo "${{ secrets.QUAY_TOKEN }}" | docker login quay.io -u ${{ secrets.QUAY_USERNAME }} --password-stdin
          
          # 2. Pull the image
          docker pull quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:${{ github.sha }}
          
          # 3. Stop & Remove old container (if exists)
          docker stop girly-app || true
          docker rm girly-app || true
          
          # 4. Run new container
          docker run -d --name girly-app -p 8080:80 quay.io/${{ secrets.QUAY_USERNAME }}/girly-app:${{ github.sha }}
